package order

import (
	"context"
	"encoding/hex"
	"fmt"
	"strings"

	"github.com/NethermindEth/juno/core/felt"
	"github.com/NethermindEth/starknet.go/utils"
	"github.com/google/uuid"
	"github.com/paycrest/aggregator/ent"
	"github.com/paycrest/aggregator/ent/fiatcurrency"
	networkent "github.com/paycrest/aggregator/ent/network"
	"github.com/paycrest/aggregator/ent/paymentorder"
	"github.com/paycrest/aggregator/ent/paymentorderfulfillment"
	"github.com/paycrest/aggregator/ent/providerordertoken"
	"github.com/paycrest/aggregator/ent/providerprofile"
	tokenent "github.com/paycrest/aggregator/ent/token"
	"github.com/paycrest/aggregator/services/starknet"
	db "github.com/paycrest/aggregator/storage"
	"github.com/paycrest/aggregator/types"
	u "github.com/paycrest/aggregator/utils"
	cryptoUtils "github.com/paycrest/aggregator/utils/crypto"
	"github.com/shopspring/decimal"
)

// OrderStarknet provides functionality related to on-chain interactions for payment orders on Starknet
type OrderStarknet struct {
	client *starknet.Client
}

// NewOrderStarknet creates a new instance of OrderStarknet
func NewOrderStarknet(client *starknet.Client) types.OrderService {
	return &OrderStarknet{
		client: client,
	}
}

// CreateOrder creates a new payment order on-chain for Starknet
func (s *OrderStarknet) CreateOrder(ctx context.Context, orderID uuid.UUID) error {
	var err error
	orderIDPrefix := strings.Split(orderID.String(), "-")[0]

	order, err := db.Client.PaymentOrder.
		Query().
		Where(paymentorder.IDEQ(orderID)).
		WithToken(func(tq *ent.TokenQuery) {
			tq.WithNetwork()
		}).
		WithSenderProfile().
		Only(ctx)
	if err != nil {
		return fmt.Errorf("%s - CreateOrder.fetchOrder: %w", orderIDPrefix, err)
	}

	if order.MessageHash != "" {
		return nil
	}

	// Create createOrder data
	encryptedOrderRecipient, err := cryptoUtils.EncryptOrderRecipient(order)
	if err != nil {
		return fmt.Errorf("%s - CreateOrder.encryptOrderRecipient: %w", orderIDPrefix, err)
	}

	// Save the encrypted order recipient to the message hash field
	_, err = order.Update().
		SetMessageHash(encryptedOrderRecipient).
		SetStatus(paymentorder.StatusPending).
		Save(ctx)
	if err != nil {
		return fmt.Errorf("%s - CreateOrder.updateMessageHash: %w", orderIDPrefix, err)
	}

	_, err = order.Update().
		SetStatus(paymentorder.StatusInitiated).
		Save(ctx)
	if err != nil {
		return fmt.Errorf("%s - CreateOrder.updateStatus: %w", orderIDPrefix, err)
	}

	// We need to get the salt from the receive address table to generate the account
	if order.ReceiveAddressSalt == nil {
		return fmt.Errorf("%s - CreateOrder.missingSalt", orderIDPrefix)
	}

	saltDecrypted, err := cryptoUtils.DecryptPlain(order.ReceiveAddressSalt)
	if err != nil {
		return fmt.Errorf("%s - CreateOrder.decryptSalt: %w", orderIDPrefix, err)
	}

	// derive seed from salt. salt is generated by adding suffix of "-paycrest" to seed
	seed := strings.TrimSuffix(string(saltDecrypted), "-paycrest")

	starknetDeterministicAccount, err := s.client.GenerateDeterministicAccount(seed)
	if err != nil {
		return fmt.Errorf("%s - CreateOrder.generateDeterministicAccount: %w", orderIDPrefix, err)
	}

	gatewayContractAddressFelt, err := utils.HexToFelt(order.Edges.Token.Edges.Network.GatewayContractAddress)
	if err != nil {
		return fmt.Errorf("%s - CreateOrder.parseGatewayAddress: %w", orderIDPrefix, err)
	}
	tokenContractFelt, err := utils.HexToFelt(order.Edges.Token.ContractAddress)
	if err != nil {
		return fmt.Errorf("%s - CreateOrder.parseTokenAddress: %w", orderIDPrefix, err)
	}
	orderAmountFelt := new(felt.Felt).SetBigInt(u.ToSubunit(order.Amount, order.Edges.Token.Decimals))
	rateFelt := new(felt.Felt).SetBigInt(order.Rate.Mul(decimal.NewFromInt(100)).BigInt())
	senderFeeRecipientFelt, err := utils.HexToFelt(order.FeeAddress)
	if err != nil {
		return fmt.Errorf("%s - CreateOrder.parseFeeAddress: %w", orderIDPrefix, err)
	}
	senderFeeFelt := new(felt.Felt).SetBigInt(u.ToSubunit(order.SenderFee, order.Edges.Token.Decimals))
	refundAddressFelt, err := utils.HexToFelt(order.ReturnAddress)
	if err != nil {
		return fmt.Errorf("%s - CreateOrder.parseRefundAddress: %w", orderIDPrefix, err)
	}

	buildReq, buildResp, err := s.client.BuildApprovalAndCreateOrderCall(
		ctx,
		starknetDeterministicAccount,
		gatewayContractAddressFelt,
		tokenContractFelt,
		orderAmountFelt,
		rateFelt,
		senderFeeRecipientFelt,
		senderFeeFelt,
		refundAddressFelt,
		encryptedOrderRecipient,
	)
	if err != nil {
		return fmt.Errorf("%s - CreateOrder.buildCreateOrderCall: %w", orderIDPrefix, err)
	}

	execReq, err := s.client.GetExecutableRequest(
		ctx,
		starknetDeterministicAccount,
		*buildReq,
		buildResp,
	)
	if err != nil {
		return fmt.Errorf("%s - CreateOrder.getExecutableRequest: %w", orderIDPrefix, err)
	}

	_, err = s.client.PaymasterExecuteTransaction(ctx, execReq)
	if err != nil {
		return fmt.Errorf("%s - CreateOrder.paymasterExecuteTransaction: %w", orderIDPrefix, err)
	}

	return nil
}

// RefundOrder processes order refund on Starknet
func (s *OrderStarknet) RefundOrder(ctx context.Context, network *ent.Network, orderID string) error {
	orderIDPrefix := strings.Split(orderID, "-")[0]

	paymentOrder, err := db.Client.PaymentOrder.
		Query().
		Where(
			paymentorder.GatewayIDEQ(orderID),
			paymentorder.HasTokenWith(
				tokenent.HasNetworkWith(
					networkent.IdentifierEQ(network.Identifier),
				),
			),
		).
		WithToken(func(tq *ent.TokenQuery) {
			tq.WithNetwork()
		}).
		First(ctx)
	if err != nil {
		return fmt.Errorf("%s - RefundOrder.fetchPaymentOrder: %w", orderIDPrefix, err)
	}

	feeFelt := new(felt.Felt).SetBigInt(u.ToSubunit(decimal.NewFromInt(0), paymentOrder.Edges.Token.Decimals))

	gatewayContractAddressFelt, err := utils.HexToFelt(paymentOrder.Edges.Token.Edges.Network.GatewayContractAddress)
	if err != nil {
		return fmt.Errorf("%s - RefundOrder.parseGatewayAddress: %w", orderIDPrefix, err)
	}
	gatewayOrderIDFelt, err := utils.HexToFelt(paymentOrder.GatewayID)
	if err != nil {
		return fmt.Errorf("%s - RefundOrder.parseGatewayOrderID: %w", orderIDPrefix, err)
	}

	// derive seed from salt. salt is generated by adding suffix of "-paycrest" to seed
	seed := strings.TrimSuffix(s.client.AggregatorSeed, "-paycrest")

	aggregatorDeterministicAccount, err := s.client.GenerateDeterministicAccount(seed)
	if err != nil {
		return fmt.Errorf("%s - RefundOrder.generateDeterministicAccount: %w", orderIDPrefix, err)
	}

	// Build refund transaction
	buildReq, buildResp, err := s.client.BuildRefundOrderCall(
		ctx,
		aggregatorDeterministicAccount.NewAccount.Address,
		gatewayContractAddressFelt,
		gatewayOrderIDFelt,
		feeFelt,
	)
	if err != nil {
		return fmt.Errorf("%s - RefundOrder.buildRefundCall: %w", orderIDPrefix, err)
	}

	execReq, err := s.client.GetExecutableRequest(
		ctx,
		aggregatorDeterministicAccount,
		*buildReq,
		buildResp,
	)
	if err != nil {
		return fmt.Errorf("%s - RefundOrder.getExecutableRequest: %w", orderIDPrefix, err)
	}

	// Execute the refund transaction through paymaster
	_, err = s.client.PaymasterExecuteTransaction(ctx, execReq)
	if err != nil {
		return fmt.Errorf("%s - RefundOrder.paymasterExecuteTransaction: %w", orderIDPrefix, err)
	}

	return nil
}

// SettleOrder settles a completed order on Starknet
func (s *OrderStarknet) SettleOrder(ctx context.Context, orderID uuid.UUID) error {
	var err error

	orderIDPrefix := strings.Split(orderID.String(), "-")[0]

	// Fetch payment order from db
	order, err := db.Client.PaymentOrder.
		Query().
		Where(
			paymentorder.IDEQ(orderID),
			paymentorder.StatusEQ(paymentorder.StatusValidated),
			paymentorder.HasFulfillmentsWith(
				paymentorderfulfillment.ValidationStatusEQ(paymentorderfulfillment.ValidationStatusSuccess),
			),
		).
		WithToken(func(tq *ent.TokenQuery) {
			tq.WithNetwork()
		}).
		WithProvider().
		Only(ctx)
	if err != nil {
		return fmt.Errorf("%s - SettleOrder.fetchOrder: %w", orderIDPrefix, err)
	}

	institution, err := u.GetInstitutionByCode(ctx, order.Institution, true)
	if err != nil {
		return fmt.Errorf("failed to get institution: %w", err)
	}

	// Fetch provider address from db
	token, err := db.Client.ProviderOrderToken.
		Query().
		Where(
			providerordertoken.NetworkEQ(order.Edges.Token.Edges.Network.Identifier),
			providerordertoken.HasProviderWith(
				providerprofile.IDEQ(order.Edges.Provider.ID),
			),
			providerordertoken.HasTokenWith(
				tokenent.IDEQ(order.Edges.Token.ID),
			),
			providerordertoken.HasCurrencyWith(
				fiatcurrency.CodeEQ(institution.Edges.FiatCurrency.Code),
			),
			providerordertoken.AddressNEQ(""),
		).
		Only(ctx)
	if err != nil {
		return fmt.Errorf("failed to fetch provider order token: %w", err)
	}

	orderPercent, _ := order.OrderPercent.
		Mul(decimal.NewFromInt(1000)). // convert percent to BPS
		Float64()

	decodedOrderID, err := hex.DecodeString(order.GatewayID[2:])
	if err != nil {
		return fmt.Errorf("failed to decode orderID: %w", err)
	}

	splitOrderID := strings.ReplaceAll(order.ID.String(), "-", "")

	// derive seed from salt. salt is generated by adding suffix of "-paycrest" to seed
	seed := strings.TrimSuffix(s.client.AggregatorSeed, "-paycrest")

	aggregatorDeterministicAccount, err := s.client.GenerateDeterministicAccount(seed)
	if err != nil {
		return fmt.Errorf("%s - SettleOrder.generateDeterministicAccount: %w", orderIDPrefix, err)
	}

	gatewayContractAddressFelt, err := utils.HexToFelt(order.Edges.Token.Edges.Network.GatewayContractAddress)
	if err != nil {
		return fmt.Errorf("%s - SettleOrder.parseGatewayAddress: %w", orderIDPrefix, err)
	}
	// Encode decodedOrderID back to hex string for HexToFelt
	gatewayOrderIDHex := "0x" + hex.EncodeToString(decodedOrderID)
	gatewayOrderIDFelt, err := utils.HexToFelt(gatewayOrderIDHex)
	if err != nil {
		return fmt.Errorf("%s - SettleOrder.parseGatewayOrderID: %w", orderIDPrefix, err)
	}
	splitOrderIDFelt, err := utils.HexToFelt(splitOrderID)
	if err != nil {
		return fmt.Errorf("%s - SettleOrder.parseSplitOrderID: %w", orderIDPrefix, err)
	}
	providerContractAddressFelt, err := utils.HexToFelt(token.Address)
	if err != nil {
		return fmt.Errorf("%s - SettleOrder.parseProviderAddress: %w", orderIDPrefix, err)
	}

	buildReq, buildResp, err := s.client.BuildSettleOrderCall(
		ctx,
		aggregatorDeterministicAccount.NewAccount.Address,
		gatewayContractAddressFelt,
		splitOrderIDFelt,
		gatewayOrderIDFelt,
		providerContractAddressFelt,
		uint64(orderPercent),
		0, // rebate percent
	)
	if err != nil {
		return fmt.Errorf("%s - SettleOrder.buildSettleCall: %w", orderIDPrefix, err)
	}

	execReq, err := s.client.GetExecutableRequest(
		ctx,
		aggregatorDeterministicAccount,
		*buildReq,
		buildResp,
	)
	if err != nil {
		return fmt.Errorf("%s - SettleOrder.getExecutableRequest: %w", orderIDPrefix, err)
	}

	// Execute the settlement transaction through paymaster
	_, err = s.client.PaymasterExecuteTransaction(ctx, execReq)
	if err != nil {
		return fmt.Errorf("%s - SettleOrder.paymasterExecuteTransaction: %w", orderIDPrefix, err)
	}

	return nil
}
